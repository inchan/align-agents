# Sync Workflow E2E ν…μ¤νΈ νΈλ¬λΈ”μν… κµν› (2024-12-16)

μ΄ λ¬Έμ„λ” `sync-workflow.spec.ts`λ¥Ό λ””λ²„κΉ…ν•κ³  μμ •ν•λ” κ³Όμ •μ—μ„ μ–»μ€ μ‹¤ν¨μ™€ μ„±κ³µ κ²½ν—μ„ κΈ°λ΅ν•©λ‹λ‹¤. ν–¥ν›„ μ μ‚¬ν• λ¬Έμ  λ°μƒ μ‹ μ°Έκ³  μλ£λ΅ ν™μ©ν•©λ‹λ‹¤.

## π« μ‹¤ν¨ κ²½ν— (What Failed)

### 1. ν…μ¤νΈ ν—¬νΌμ™€ μ‹¤μ  APIμ λ¶μΌμΉ
- **μ¦μƒ**: `resetDatabase`λ‚ `seedMcpData`κ°€ μ¤λ¥ μ—†μ΄ μ‹¤ν–‰λλ” κ²ƒμ²λΌ λ³΄μ€μΌλ‚, μ‹¤μ λ΅λ” λ°μ΄ν„°κ°€ μ΄κΈ°ν™”λκ±°λ‚ μƒμ„±λμ§€ μ•μ.
- **μ›μΈ**: ν—¬νΌ(`sync.helpers.ts`)κ°€ λ κ±°μ‹ μ—”λ“ν¬μΈνΈ(`/api/mcp/sets`)λ¥Ό μ‚¬μ©ν•κ³  μμ—μΌλ‚, μ‹¤μ  μ•±μ€ μµμ‹  μ—”λ“ν¬μΈνΈ(`/api/mcp-sets`)λ¥Ό μ‚¬μ©. 404 μ—λ¬κ°€ λ°μƒν–μ§€λ§ `try-catch`λ‚ λ¶€μ‹¤ν• λ΅κΉ…μΌλ΅ μΈν•΄ λ¬µμΈλ¨.
- **κµν›**: ν…μ¤νΈ ν—¬νΌ μ‘μ„± μ‹ `api.ts`μ μƒμλ¥Ό μ¬μ‚¬μ©ν•κ±°λ‚, μ—”λ“ν¬μΈνΈ κ²½λ΅λ¥Ό μ΄μ¤‘μΌλ΅ ν™•μΈν•΄μ•Ό ν•¨. μ‹¤ν¨ μ‹ λ°λ“μ‹ λ…μ‹μ μΈ μ—λ¬λ¥Ό λμ§€λ„λ΅ μ‘μ„±ν•  κ²ƒ.

### 2. Playwright Strict Mode μ„λ°
- **μ¦μƒ**: `expect(locator).toBeVisible()`μ—μ„ "resolved to 2 elements" μ—λ¬ λ°μƒ.
- **μ›μΈ**: `getByTestId('check-icon').or(page.locator('.lucide-check'))` κµ¬λ¬Έ μ‚¬μ© μ‹, μ•λ¶€λ¶„μ€ μ¤μ½”ν”„κ°€ μ§€μ •λμ—μΌλ‚ λ’·λ¶€λ¶„(`page.locator`)μ€ μ „μ—­ μ¤μ½”ν”„λΌ νμ΄μ§€ λ‚΄μ λ‹¤λ¥Έ μ²΄ν¬ μ•„μ΄μ½κΉμ§€ λ§¤μΉ­λ¨.
- **κµν›**: `.or()` μ‚¬μ© μ‹ λ€μ²΄ μ„ νƒμλ„ λ¶€λ¨ λ΅μΌ€μ΄ν„° λ‚΄λ΅ ν•μ •(scope)ν•΄μ•Ό ν•¨. κ°€λ¥ν•λ©΄ `data-testid`λ¥Ό μ‚¬μ©ν•μ—¬ λ¨νΈν•¨μ„ μ κ±°ν•λ” κ²ƒμ΄ μµμ„ .

### 3. λ°±μ—”λ“ μ μ•½ μ΅°κ±΄μ— μν• ν…μ¤νΈ μ •λ¦¬ μ‹¤ν¨
- **μ¦μƒ**: `resetDatabase` μ‹¤ν–‰ μ¤‘ 500 μ—λ¬ λ°μƒ.
- **μ›μΈ**: `McpRepository`μ `deleteSet` λ©”μ„λ“κ°€ "ν™μ„±(Active) μƒνƒμΈ Setμ€ μ‚­μ  λ¶κ°€"λΌλ” λΉ„μ¦λ‹μ¤ λ΅μ§μ„ ν¬ν•¨ν•κ³  μμ—μ. ν…μ¤νΈ μ •λ¦¬λ” μ΄ λ΅μ§μ„ μ°νν•΄μ•Ό ν•¨.
- **κµν›**: ν…μ¤νΈ ν™κ²½μ—μ„λ” κ°•μ  μ‚­μ κ°€ κ°€λ¥ν•΄μ•Ό ν•λ―€λ΅, Repository λ λ²¨μ—μ„ μ΄λ¥Ό ν—μ©ν•κ±°λ‚ ν…μ¤νΈ μ „μ© "Force Delete" μ—”λ“ν¬μΈνΈ/νλΌλ―Έν„°κ°€ ν•„μ”ν•¨.

### 4. React useEffect κ²½ν•© μ΅°κ±΄ (Race Condition)
- **μ¦μƒ**: ν…μ¤νΈκ°€ ν΄λ¦­μ„ μν–‰ν–μμ—λ„ UIκ°€ μ„ νƒλμ§€ μ•μ€ μƒνƒλ΅ λλμ•„κ°.
- **μ›μΈ**: `SyncPage.tsx`μ `useEffect` μμ΅΄μ„± λ°°μ—΄μ— `store` μ „μ²΄κ°€ ν¬ν•¨λμ–΄ μμ–΄, μ„ νƒ μƒνƒκ°€ λ³€κ²½λ  λ•λ§λ‹¤ ν¨κ³Όκ°€ μ¬μ‹¤ν–‰λμ–΄ μ΄κΈ°ν™” λ΅μ§μ΄ λ™μ‘ν•¨.
- **κµν›**: `useEffect` μμ΅΄μ„±μ—λ” λ°λ“μ‹ ν•„μ”ν• μ›μ‹ κ°’(primitive)μ΄λ‚ μ•μ •μ μΈ ν•¨μ(`useCallback` λ“±)λ§ ν¬ν•¨μ‹μΌμ•Ό ν•¨.

## β… μ„±κ³µ κ²½ν— (What Worked)

### 1. κ²©λ¦¬λ μλ™ λ””λ²„κ·Έ ν…μ¤νΈ (`debug_manual.spec.ts`)
- λ³µμ΅ν• μ „μ²΄ ν…μ¤νΈ μ¤μ„νΈ λ€μ‹ , λ°μ΄ν„° μ‹λ”©κ³Ό ν΄λ¦­ λ“± μµμ†ν•μ λ‹¨κ³„λ§ μν–‰ν•κ³  `page.waitForTimeout`μΌλ΅ λ©μ¶”λ” μ„μ‹ ν…μ¤νΈ νμΌμ„ μƒμ„±.
- μ΄λ¥Ό ν†µν•΄ λ¬Έμ κ°€ "λ°μ΄ν„° μ‹λ”©"μΈμ§€ "UI λ λ”λ§"μΈμ§€ "ν…μ¤νΈ μ½”λ“"μΈμ§€ λΉ λ¥΄κ² λ¶„λ¦¬ν•μ—¬ νμ•… κ°€λ¥ν–μ.

### 2. λΈλΌμ°μ € μ½μ†” λ΅κ·Έ μΊ΅μ²
- `page.on('console', msg => console.log(...))`λ¥Ό μ¶”κ°€ν•μ—¬ λΈλΌμ°μ € λ‚΄λ¶€μ `console.log`λ¥Ό ν„°λ―Έλ„μ—μ„ ν™•μΈ.
- ν΄λ¦­ μ΄λ²¤νΈ ν•Έλ“¤λ¬κ°€ μ‹¤μ λ΅ μ‹¤ν–‰λλ”μ§€(`CLICKED MCP Set` λ΅κ·Έ) ν™•μΈν•λ” λ° κ²°μ •μ μ΄μ—μ.

### 3. `test.only`λ¥Ό ν†µν• μ§‘μ¤‘
- μ „μ²΄ ν…μ¤νΈλ¥Ό λλ¦¬λ” μ‹κ°„μ„ λ‚­λΉ„ν•μ§€ μ•κ³ , λ¬Έμ κ°€ λλ” λ‹¨μΌ ν…μ¤νΈ μΌ€μ΄μ¤μ—λ§ μ§‘μ¤‘ν•μ—¬ λΉ λ¥Έ ν”Όλ“λ°± λ£¨ν”„ ν•μ„±.

### 4. `data-testid` λ„μ…
- CSS ν΄λμ¤λ‚ ν…μ¤νΈ λ‚΄μ©μ— μμ΅΄ν•λ” μ„ νƒμλ” κΉ¨μ§€κΈ° μ‰¬μ›€. `Check` μ»΄ν¬λ„νΈμ— `data-testid="check-icon"`μ„ μ¶”κ°€ν•μ—¬ ν…μ¤νΈ μ‹ λΆ°μ„±μ„ μ¦‰κ°μ μΌλ΅ λ†’μ„.
